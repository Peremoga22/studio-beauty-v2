@page "/admin-history-of-gift-sertificate-services"
@using System.Threading.Tasks
@inject GiftCertificateService _giftCertificateService
@inject NavigationManager _navigationManager
@layout AdminLayout
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin")]

<div class="container my-4">  
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mb-3">
        <div>
            <h3 class="mb-1 fw-bold" style="color:#f8b7d8;">
                🎀 Історія створених подарункових сертифікатів
            </h3>
            <p class="text-muted mb-0 small">
                Тут ви можете переглянути всі сертифікати та підтвердити їх.
            </p>
        </div>

        <div class="text-md-end">
            <span class="badge rounded-pill bg-light text-muted border">
                Всього: <strong>@(Certificates?.Count ?? 0)</strong>
            </span>
        </div>
    </div>

    <nav aria-label="breadcrumb" class="bg-white shadow-sm rounded px-3 py-2 mb-4">
        <ol class="breadcrumb mb-0 small">
            <li class="breadcrumb-item text-muted">Адміністративна панель</li>
            <li class="breadcrumb-item active" aria-current="page">
                Історія створених подарункових сертифікатів
            </li>
        </ol>
    </nav>
       
    @if (Certificates == null)
    {
        <div class="text-center text-muted py-5">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            Завантаження сертифікатів...
        </div>
    }
    else if (!Certificates.Any())
    {
        <div class="text-center text-muted py-5">
            <p class="mb-1">Поки що немає створених подарункових сертифікатів.</p>
            <p class="small mb-0">Коли клієнти оформлять сертифікати — вони з’являться тут.</p>
        </div>
    }
    else
    {
        <div class="row g-4">
            @foreach (var cert in Certificates)
            {
                <div class="col-lg-4 col-md-6">
                    <div class="card admin-cert-card border-0 shadow-sm h-100 position-relative">

                        <!-- Верх: бренд + статус + delete -->
                        <div class="card-header bg-white border-0 pb-0">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="admin-cert-brand">Shine Cosmetology</div>
                                    <div class="admin-cert-brand-sub">Подарунковий сертифікат</div>
                                </div>

                                <div class="d-flex align-items-start gap-2">
                                    @if (cert.IsApproved)
                                    {
                                        <span class="admin-cert-status admin-cert-status-approved">
                                            ✅ Активовано
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="admin-cert-status admin-cert-status-pending">
                                            ⏳ Очікує оплату
                                        </span>
                                    }

                                    <button class="btn btn-sm btn-icon-danger"
                                            title="Видалити"
                                            @onclick="() => DeleteGiftCertificate(cert.Id)">
                                        🗑
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Тіло -->
                        <div class="card-body pt-2">

                            <div class="admin-cert-title-main text-center mb-2">
                                ПОДАРУНКОВИЙ СЕРТИФІКАТ
                            </div>

                            <div class="admin-cert-line mb-3"></div>

                            <div class="mb-2">
                                <div class="admin-cert-label">Отримувач</div>
                                <div class="admin-cert-value fw-semibold">
                                    @cert.RecipientName
                                </div>
                            </div>

                            <div class="d-flex justify-content-between mb-2">
                                <div>
                                    <div class="admin-cert-label">Сертифікат №</div>
                                    <div class="admin-cert-value">#@cert.Id</div>
                                </div>
                                <div class="text-end">
                                    <div class="admin-cert-label">Номінал</div>
                                    <div class="admin-cert-amount">
                                        @cert.Amount.ToString("N0") грн
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between mb-2">
                                <div>
                                    <div class="admin-cert-label">Термін дії</div>
                                    <div class="admin-cert-value">3 місяці</div>
                                </div>
                                <div class="text-end">
                                    <div class="admin-cert-label">Створено</div>
                                    <div class="admin-cert-value">
                                        @cert.CreatedAt.ToString("dd.MM.yyyy")
                                    </div>
                                </div>
                            </div>

                            <div class="cert-row mb-1">
                                <div class="cert-label">Замовник:</div>
                                <div class="cert-value">
                                    @cert.ClientName
                                </div>
                            </div>

                            <div class="cert-row">
                                <div class="cert-label">Телефон замовника:</div>
                                <div class="cert-value text-muted">
                                    @cert.ClientPhone
                                </div>
                            </div>
                        </div>

                        <!-- Футер -->
                        <div class="card-footer bg-white border-0 pt-0">
                            <div class="d-flex justify-content-between align-items-center">

                                <span class="small text-muted">
                                    ID: @cert.Id
                                </span>

                                <div class="d-flex gap-2">
                                    <a @onclick="() => DownloadPdf(cert.Id)"
                                       class="btn btn-outline-secondary btn-sm rounded-pill">
                                        ⬇ PDF
                                    </a>

                                    <button class="btn btn-sm rounded-pill cert-action-btn"
                                            @onclick="@(() => OnCertificateClick(cert.Id))"
                                            disabled="@cert.IsApproved">
                                        @if (!cert.IsApproved)
                                        {
                                            <span>Підтвердити оплату</span>
                                        }
                                        else
                                        {
                                            <span>Оплачено</span>
                                        }
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            }
        </div>

    }
</div>

@code {
    public List<GiftCertificateWithClientDto> Certificates { get; set; } = new();
    
    protected override async Task OnInitializedAsync()
    {   
        Certificates = await _giftCertificateService.GetGiftCertificatesAll();
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnCertificateClick(int id)
    {
        await _giftCertificateService.ApproveGiftCertificateAsync(id);
        Certificates = await _giftCertificateService.GetGiftCertificatesAll();
    }

    private async Task DeleteGiftCertificate(int id)
    {
        await _giftCertificateService.DeleteGiftCertificateAsync(id);
        Certificates = await _giftCertificateService.GetGiftCertificatesAll();
        StateHasChanged();
    }

    private async Task DownloadPdf(int id)
    {
        var result = await _giftCertificateService.DownloadGiftCertificatePdfAsync(id);
        Console.WriteLine(result);
    }
}
