@page "/admin/add-treatment-history/{Id:int}"

@attribute [Authorize(Roles = "Admin,Manicure")]
@rendermode InteractiveServer

@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Forms

<PageTitle>Додати історію процедури</PageTitle>
<h3 style="padding-top: 3%;"></h3>
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-9 col-xl-8">

            <div class="d-flex align-items-center justify-content-between gap-3 mb-3">
                <div>
                    <h2 class="mb-1">Історія відвідування клієнта</h2>
                    <div class="text-muted">Клієнт/картка ID: <b>@Id</b></div>
                </div>

                <div class="d-flex gap-2">
                    <a class="btn btn-outline-secondary" href="/admin/clients">← Назад</a>
                </div>
            </div>

            @if (!string.IsNullOrWhiteSpace(AlertText))
            {
                <div class="alert @AlertCss mb-3" role="alert">
                    @AlertText
                </div>
            }

            <div class="card border-0 shadow-sm rounded-4">
                <div class="card-body p-3 p-md-4">

                    <EditForm Model="@Form" OnValidSubmit="SaveAsync">
                        <DataAnnotationsValidator />
                        <ValidationSummary class="text-danger mb-3" />

                        <div class="row g-3">
                            <div class="col-12 col-md-6">
                                <label class="form-label">Дата візиту</label>
                                <InputDate class="form-control" @bind-Value="Form.VisitDate" />
                            </div>

                            <div class="col-12 col-md-6">
                                <label class="form-label">Процедура</label>
                                <InputText class="form-control" @bind-Value="Form.ProcedureName" placeholder="Напр. Манікюр / Подологія" />
                                <ValidationMessage For="() => Form.ProcedureName" class="text-danger small" />
                            </div>

                            <div class="col-12 col-md-6">
                                <label class="form-label">Майстер</label>
                                <InputText class="form-control" @bind-Value="Form.MasterName" placeholder="Ім'я майстра" />
                            </div>

                            <div class="col-12 col-md-6">
                                <label class="form-label">Тривалість (хв)</label>
                                <InputNumber class="form-control" @bind-Value="Form.DurationMinutes" />
                                <ValidationMessage For="() => Form.DurationMinutes" class="text-danger small" />
                            </div>

                            <div class="col-12 col-md-4">
                                <label class="form-label">Ціна (грн)</label>
                                <InputNumber class="form-control" @bind-Value="Form.Price" />
                                <ValidationMessage For="() => Form.Price" class="text-danger small" />
                            </div>

                            <div class="col-12 col-md-4">
                                <label class="form-label">Статус</label>
                                <InputSelect class="form-select" @bind-Value="Form.Status">
                                    <option value="Done">Виконано</option>
                                    <option value="Planned">Заплановано</option>
                                    <option value="Canceled">Скасовано</option>
                                </InputSelect>
                            </div>

                            <div class="col-12 col-md-4">
                                <label class="form-label">Фото/Файл (посилання)</label>
                                <InputText class="form-control" @bind-Value="Form.MediaUrl" placeholder="https://..." />
                            </div>

                            <div class="col-12">
                                <label class="form-label">Нотатки</label>
                                <InputTextArea class="form-control" @bind-Value="Form.Notes" rows="5"
                                               placeholder="Скарги, стан, що зроблено, рекомендації, наступний візит..." />
                                <ValidationMessage For="() => Form.Notes" class="text-danger small" />
                            </div>

                            <div class="col-12">
                                <div class="d-flex flex-column flex-sm-row gap-2 justify-content-end mt-2">
                                    <button type="button" class="btn btn-outline-danger"
                                            @onclick="ClearForm" disabled="@IsBusy">
                                        Очистити
                                    </button>

                                    <button type="submit" class="btn btn-primary"
                                            disabled="@IsBusy">
                                        @if (IsBusy)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"> "Збереження"</span>
                                           
                                        }
                                        else
                                        {
                                            <span>Зберегти</span>
                                        }
                                    </button>
                                </div>
                            </div>
                        </div>
                    </EditForm>

                </div>
            </div>

            <div class="text-muted small mt-3">
                Порада: якщо потрібне підтвердження видалення/скасування — скажи, зроблю модалку як “точно видалити?”.
            </div>

        </div>
    </div>
</div>

@code {
    [Parameter] public int Id { get; set; }

    private TreatmentHistoryForm Form { get; set; } = new();
    private bool IsBusy { get; set; }

    private string? AlertText { get; set; }
    private string AlertCss { get; set; } = "alert-info";

    protected override void OnInitialized()
    {
        // Тут можна підвантажити дані клієнта/картки по Id (ім’я, телефон) і показувати зверху.
        Form.VisitDate = DateTime.Today;
        Form.Status = "Done";
    }

    private async Task SaveAsync()
    {
        if (IsBusy) return;
        IsBusy = true;
        AlertText = null;

        try
        {
            // TODO: заміни на свій сервіс, наприклад:
            // await _treatmentHistoryService.AddAsync(Id, Form);

            await Task.Delay(400); // імітація запиту

            AlertCss = "alert-success";
            AlertText = "✅ Запис успішно збережено.";
        }
        catch
        {
            AlertCss = "alert-danger";
            AlertText = "❌ Не вдалося зберегти. Спробуй ще раз.";
        }
        finally
        {
            IsBusy = false;
        }
    }

    private void ClearForm()
    {
        Form = new TreatmentHistoryForm
        {
            VisitDate = DateTime.Today,
            Status = "Done"
        };

        AlertText = "Форму очищено.";
        AlertCss = "alert-warning";
    }

    public sealed class TreatmentHistoryForm
    {
        [Required(ErrorMessage = "Вкажи назву процедури")]
        [StringLength(120, ErrorMessage = "Занадто довга назва (макс. 120 символів)")]
        public string? ProcedureName { get; set; }

        public DateTime VisitDate { get; set; } = DateTime.Today;

        [StringLength(80)]
        public string? MasterName { get; set; }

        [Range(0, 600, ErrorMessage = "Тривалість має бути 0–600 хв")]
        public int? DurationMinutes { get; set; }

        [Range(0, 100000, ErrorMessage = "Ціна має бути 0–100000")]
        public decimal? Price { get; set; }

        // Done / Planned / Canceled
        public string Status { get; set; } = "Done";

        [Url(ErrorMessage = "Посилання має бути валідним URL")]
        public string? MediaUrl { get; set; }

        [Required(ErrorMessage = "Додай короткі нотатки (що зроблено / рекомендації)")]
        [StringLength(2000, ErrorMessage = "Нотатки надто довгі (макс. 2000 символів)")]
        public string? Notes { get; set; }
    }
}
